<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰é™å°æ ‘</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: white; /* æ”¹ä¸ºç™½è‰²èƒŒæ™¯ */
            margin: 0;
            padding: 20px;
        }
        .grass {
            background-color: white; /* è‰åœ°ä¹Ÿæ”¹ä¸ºç™½è‰² */
            height: 300px;
            width: 100%;
            position: relative;
            margin-top: 30px;
            border-radius: 10px;
            border: 1px solid #ddd; /* æ·»åŠ è¾¹æ¡†ä»¥ä¾¿çœ‹æ¸…è¾¹ç•Œ */
        }
        .tree {
            position: absolute;
            transition: all 0.5s ease;
            width: 30px; /* å¢åŠ å°æ ‘å®½åº¦ */
            height: 30px; /* å¢åŠ å°æ ‘é«˜åº¦ */
            font-size: 24px; /* å¢å¤§è¡¨æƒ…ç¬¦å· */
        }
        .settings {
            margin: 10px 0; /* ç¼©å°è®¾ç½®åŒºåŸŸ */
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <h1>å˜˜ï¼Œè®©å°æ ‘å®‰é™ç”Ÿé•¿ï¼ğŸŒ±ğŸŒ³</h1>
    
    <div class="controls">
        <button id="startBtn">å¼€å§‹æ£€æµ‹</button>
        <button id="resetBtn">é‡ç½®å°æ ‘</button>
    </div>
    
    <div id="dBDisplay">å½“å‰åˆ†è´å€¼: -- dB</div>
    
    <div class="settings">
        <label for="growthThreshold">å®‰é™åˆ†è´å€¼ (å°æ ‘ç”Ÿé•¿): </label>
        <input type="number" id="growthThreshold" value="40" min="0" max="100">
        <label for="witherThreshold">å™ªéŸ³åˆ†è´å€¼ (å°æ ‘æ¯è): </label>
        <input type="number" id="witherThreshold" value="70" min="0" max="100">
    </div>
    
    <div class="grass" id="grass"></div>

    <script>
        const grass = document.getElementById('grass');
        const dBDisplay = document.getElementById('dBDisplay');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const growthThresholdInput = document.getElementById('growthThreshold');
        const witherThresholdInput = document.getElementById('witherThreshold');
        
        // å…¨å±€å˜é‡å£°æ˜
        let audioContext;
        let analyser;
        let microphone;
        let isRunning = false;
        let trees = [];
        let witheredTime = 0;
        
        // å°æ ‘ç”Ÿé•¿æ§åˆ¶å˜é‡
        let lastTreeUpdateTime = 0;
        let currentGrowingTreeIndex = -1;
        let isTreeGrowing = false;
        let currentTreeStage = 0;
        
        // å™ªéŸ³æ§åˆ¶å˜é‡
        let lastNoisyTime = 0;
        let witheredCount = 0;
        let lastProcessedTreeIndex = -1; // æ·»åŠ è¿™ä¸ªç¼ºå¤±çš„å£°æ˜

        // ä¿®æ”¹åˆ›å»ºå°æ ‘å‡½æ•°
        function createTrees() {
            grass.innerHTML = '';
            trees = [];
            const now = Date.now();
            
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 10; col++) {
                    const tree = document.createElement('div');
                    tree.className = 'tree tree-seedling';
                    tree.style.left = `${(col + 0.5) * 9}%`;
                    tree.style.top = `${220 - row * 60}px`;
                    tree.innerHTML = 'ğŸŒ±';
                    tree.dataset.state = 'seedling';
                    tree.dataset.lastUpdate = now; // åˆå§‹åŒ–æ—¶é—´æˆ³
                    grass.appendChild(tree);
                    trees.push(tree);
                }
            }
        }
        
        // ä¿®æ”¹æ›´æ–°å‡½æ•°
        function updateTrees(dB) {
            const growthThreshold = parseInt(growthThresholdInput.value);
            const witherThreshold = parseInt(witherThresholdInput.value);
            const now = Date.now();
            
            if (dB >= witherThreshold) {
                // è®°å½•å¼€å§‹å˜åµçš„æ—¶é—´
                if (lastNoisyTime === 0) {
                    lastNoisyTime = now;
                }
                
                // æ¯20ç§’æ¯èä¸€æ£µæ ‘
                if (now - lastNoisyTime >= 20000) {
                    lastNoisyTime = now;
                    
                    // æ¯èå½“å‰ç”Ÿé•¿ä¸­çš„å°æ ‘
                    if (isTreeGrowing && currentGrowingTreeIndex >= 0) {
                        const tree = trees[currentGrowingTreeIndex];
                        if (tree.dataset.state !== 'withered') {
                            tree.dataset.state = 'withered';
                            tree.className = 'tree tree-withered';
                            tree.innerHTML = 'ğŸ‚';
                            // é‡ç½®ç”Ÿé•¿çŠ¶æ€
                            isTreeGrowing = false;
                            currentTreeStage = 0;
                            lastTreeUpdateTime = now;
                        }
                    }
                }
            } else if (dB <= growthThreshold) {  // åªæœ‰å½“åˆ†è´å€¼ä½äºgrowthThresholdæ—¶æ‰ç”Ÿé•¿
                // ç¯å¢ƒå®‰é™æ—¶é‡ç½®å˜åµè®¡æ—¶
                lastNoisyTime = 0;
                
                // å¦‚æœæ²¡æœ‰å°æ ‘åœ¨ç”Ÿé•¿ï¼Œé€‰æ‹©ä¸‹ä¸€æ£µ
                if (!isTreeGrowing) {
                    currentGrowingTreeIndex = (currentGrowingTreeIndex + 1) % trees.length;
                    isTreeGrowing = true;
                    currentTreeStage = 0;
                    lastTreeUpdateTime = now;
                }
                
                // å¤„ç†å½“å‰æ­£åœ¨ç”Ÿé•¿çš„å°æ ‘
                const tree = trees[currentGrowingTreeIndex];
                if (now - lastTreeUpdateTime >= 20000) {
                    lastTreeUpdateTime = now;
                    
                    // å¦‚æœæ˜¯æ¯èçŠ¶æ€ï¼Œæ¢å¤ä¸ºå¹¼è‹—
                    if (tree.dataset.state === 'withered') {
                        tree.dataset.state = 'seedling';
                        tree.className = 'tree tree-seedling';
                        tree.innerHTML = 'ğŸŒ±';
                        currentTreeStage = 0;
                    } 
                    // å¦åˆ™æ­£å¸¸ç”Ÿé•¿
                    else {
                        if (currentTreeStage === 0) {
                            tree.dataset.state = 'growing';
                            tree.className = 'tree tree-growing';
                            tree.innerHTML = 'ğŸŒ¿';
                            currentTreeStage = 1;
                        } else if (currentTreeStage === 1) {
                            tree.dataset.state = 'flowering';
                            tree.className = 'tree tree-flowering';
                            tree.innerHTML = 'ğŸŒ²';
                            currentTreeStage = 2;
                        } else if (currentTreeStage === 2) {
                            tree.dataset.state = 'fruiting';
                            tree.className = 'tree tree-fruiting';
                            tree.innerHTML = 'ğŸŒ³';
                            isTreeGrowing = false;
                        }
                    }
                }
            }
            // å½“åˆ†è´å€¼åœ¨growthThresholdå’ŒwitherThresholdä¹‹é—´æ—¶ï¼Œä¸åšä»»ä½•å¤„ç†
        }
        
        // å¼€å§‹éŸ³é¢‘æ£€æµ‹
        async function startDetection() {
            if (isRunning) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                isRunning = true;
                startBtn.textContent = 'æ£€æµ‹ä¸­...';
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                function analyze() {
                    if (!isRunning) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / dataArray.length;
                    const dB = Math.round(average);
                    
                    dBDisplay.textContent = `å½“å‰åˆ†è´å€¼: ${dB} dB`;
                    updateTrees(dB);
                    
                    requestAnimationFrame(analyze);
                }
                
                analyze();
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                isRunning = false;
                startBtn.textContent = 'å¼€å§‹æ£€æµ‹';
            }
        }
        
        // åœæ­¢æ£€æµ‹
        function stopDetection() {
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            isRunning = false;
            startBtn.textContent = 'å¼€å§‹æ£€æµ‹';
        }
        
        // é‡ç½®å°æ ‘
        function resetTrees() {
            createTrees();
            witheredTime = 0;
        }
        
        // äº‹ä»¶ç›‘å¬
        startBtn.addEventListener('click', () => {
            if (isRunning) {
                stopDetection();
            } else {
                startDetection();
            }
        });
        
        resetBtn.addEventListener('click', resetTrees);
        
        // åˆå§‹åŒ–
        createTrees();
    </script>
</body>
</html>